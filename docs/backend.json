{
  "entities": {
    "UserAccount": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserAccount",
      "type": "object",
      "description": "Represents a user's account within the MX Sweeps Exchange platform.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user account."
        },
        "mxRacehubId": {
          "type": "string",
          "description": "User's ID from MXRacehub. Used for account synchronization."
        },
        "sweepsCoinBalance": {
          "type": "number",
          "description": "The user's current sweeps coin balance.",
          "format": "float"
        },
        "usdBalance": {
          "type": "number",
          "description": "The user's current USD balance.",
          "format": "float"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the account was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the account was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "mxRacehubId",
        "sweepsCoinBalance",
        "usdBalance",
        "createdAt",
        "updatedAt"
      ]
    },
    "Transaction": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Transaction",
      "type": "object",
      "description": "Represents a single transaction within the MX Sweeps Exchange platform.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the transaction."
        },
        "userAccountId": {
          "type": "string",
          "description": "Reference to UserAccount. (Relationship: UserAccount 1:N Transaction)"
        },
        "transactionType": {
          "type": "string",
          "description": "Type of transaction (e.g., 'deposit', 'withdrawal', 'exchange')."
        },
        "sweepsCoinAmount": {
          "type": "number",
          "description": "Amount of sweeps coins involved in the transaction. Can be positive or negative.",
          "format": "float"
        },
        "usdAmount": {
          "type": "number",
          "description": "Amount of USD involved in the transaction. Can be positive or negative.",
          "format": "float"
        },
        "exchangeRate": {
          "type": "number",
          "description": "The exchange rate used for the transaction (sweeps coins to USD).",
          "format": "float"
        },
        "transactionDate": {
          "type": "string",
          "description": "Date and time when the transaction occurred.",
          "format": "date-time"
        },
        "description": {
          "type": "string",
          "description": "Description of the transaction",
          "format": "string"
        }
      },
      "required": [
        "id",
        "userAccountId",
        "transactionType",
        "sweepsCoinAmount",
        "usdAmount",
        "exchangeRate",
        "transactionDate"
      ]
    },
    "WithdrawalRequest": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "WithdrawalRequest",
      "type": "object",
      "description": "Represents a user's request to withdraw USD from their account.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the withdrawal request."
        },
        "userAccountId": {
          "type": "string",
          "description": "Reference to UserAccount. (Relationship: UserAccount 1:N WithdrawalRequest)"
        },
        "usdAmount": {
          "type": "number",
          "description": "The amount of USD the user wishes to withdraw.",
          "format": "float"
        },
        "withdrawalMethod": {
          "type": "string",
          "description": "The user's chosen method for withdrawal (e.g., PayPal, bank transfer)."
        },
        "withdrawalDetails": {
          "type": "string",
          "description": "Details for the withdrawal method (e.g., PayPal email address, bank account number)."
        },
        "requestDate": {
          "type": "string",
          "description": "Date and time when the withdrawal request was submitted.",
          "format": "date-time"
        },
        "status": {
          "type": "string",
          "description": "The current status of the withdrawal request (e.g., 'pending', 'approved', 'rejected')."
        },
        "processedDate": {
          "type": "string",
          "description": "Date and time when the withdrawal request was processed.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userAccountId",
        "usdAmount",
        "withdrawalMethod",
        "withdrawalDetails",
        "requestDate",
        "status"
      ]
    },
    "ComplianceAlert": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ComplianceAlert",
      "type": "object",
      "description": "Represents an alert generated by the compliance tool for unusual or suspicious activity.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the compliance alert."
        },
        "userAccountId": {
          "type": "string",
          "description": "Reference to UserAccount. (Relationship: UserAccount 1:N ComplianceAlert) The user account associated with the alert."
        },
        "alertType": {
          "type": "string",
          "description": "The type of compliance alert (e.g., 'large_transaction', 'unusual_activity')."
        },
        "description": {
          "type": "string",
          "description": "A detailed description of the suspicious activity."
        },
        "alertDate": {
          "type": "string",
          "description": "Date and time when the alert was generated.",
          "format": "date-time"
        },
        "status": {
          "type": "string",
          "description": "The current status of the alert (e.g., 'open', 'under_review', 'resolved')."
        },
        "resolutionDetails": {
          "type": "string",
          "description": "Details of how the alert was resolved."
        }
      },
      "required": [
        "id",
        "userAccountId",
        "alertType",
        "description",
        "alertDate",
        "status"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "UserAccount",
          "schema": {
            "$ref": "#/backend/entities/UserAccount"
          },
          "description": "Stores user account data.  Path-based ownership ensures only the user can access their account.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user account, matching the Firebase Auth UID."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/transactions/{transactionId}",
        "definition": {
          "entityName": "Transaction",
          "schema": {
            "$ref": "#/backend/entities/Transaction"
          },
          "description": "Stores transaction history for each user. Path-based ownership ensures only the user can access their transactions. Includes redundant `userAccountId` field for clarity.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user account."
            },
            {
              "name": "transactionId",
              "description": "The unique identifier for the transaction."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/withdrawalRequests/{withdrawalRequestId}",
        "definition": {
          "entityName": "WithdrawalRequest",
          "schema": {
            "$ref": "#/backend/entities/WithdrawalRequest"
          },
          "description": "Stores withdrawal requests for each user. Path-based ownership ensures only the user can access their withdrawal requests.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user account."
            },
            {
              "name": "withdrawalRequestId",
              "description": "The unique identifier for the withdrawal request."
            }
          ]
        }
      },
      {
        "path": "/complianceAlerts/{complianceAlertId}",
        "definition": {
          "entityName": "ComplianceAlert",
          "schema": {
            "$ref": "#/backend/entities/ComplianceAlert"
          },
          "description": "Stores compliance alerts. Accessible only to administrators.",
          "params": [
            {
              "name": "complianceAlertId",
              "description": "The unique identifier for the compliance alert."
            }
          ]
        }
      },
      {
        "path": "/roles_admin/{userId}",
        "definition": {
          "entityName": "roles_admin",
          "schema": {
            "$ref": "#/backend/entities/UserAccount"
          },
          "description": "Presence in this collection grants admin privileges. Existence over content.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user account."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore data structure is designed to ensure security, scalability, and debuggability, following the core principles of Authorization Independence, Clarity of Intent, DBAC (Database-Based Access Control), and QAPs (Rules are not Filters). It uses denormalization to avoid hierarchical authorization dependencies, structural segregation for homogeneous security postures, and standardized access modeling.\n\n*   **User Accounts:** User accounts are stored in `/users/{userId}`, enabling path-based ownership for private data. This simplifies security rules, ensuring only the authenticated user can access their account data.\n*   **Transactions:** Transactions are stored in `/users/{userId}/transactions/{transactionId}`, which follows the pattern `/users/{userId}/entityName/{entityId}`. This enforces clear ownership. The `userAccountId` field within each transaction document is redundant but serves to clarify ownership. This setup supports secure `list` operations, preventing unauthorized access to transaction history.\n*   **Withdrawal Requests:** Withdrawal requests are stored in `/users/{userId}/withdrawalRequests/{withdrawalRequestId}`, following the user-owned pattern. Access is restricted to the user who initiated the request.\n*   **Compliance Alerts:** Compliance alerts are stored in a separate collection `/complianceAlerts/{complianceAlertId}`. This segregation is crucial because compliance alerts are not user-owned. Admin access to these alerts is controlled via the `/roles_admin/{uid}` collection.  Since the `userAccountId` is stored, one can build an index to show which alerts are tied to which user. Since they are not user owned, this prevents a user from trying to read/write alerts that do not belong to them.\n\n**Authorization Independence (Denormalization):**\n\n*   The design eliminates `get()` calls in security rules by using path-based ownership for user-specific data (accounts, transactions, withdrawal requests). The admin can read/write to the `/complianceAlerts/{complianceAlertId}` and is authorized via the `/roles_admin/{uid}` collection.\n\n**QAPs (Rules are not Filters):**\n\n*   The structure supports secure `list` operations by segregating data based on ownership and access requirements. Path-based ownership ensures that listing documents within `/users/{userId}/transactions` or `/users/{userId}/withdrawalRequests` only returns data owned by the authenticated user."
  }
}