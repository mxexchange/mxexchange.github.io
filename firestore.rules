/**
 * @title Firebase Security Rules for MX Sweeps Exchange
 * @version 1.0
 *
 * @description
 * This ruleset enforces a strict, hybrid security model combining user ownership
 * with role-based access control (RBAC) to protect sensitive financial and
 * compliance data. The default security posture is to deny all access unless
 * explicitly granted.
 *
 * @philosophy
 * Core Philosophy: A user's data is their own. All user-specific information,
 * including their account details, transactions, and withdrawal requests, is
 * strictly confined to that user. A separate, privileged role ('admin') is
 * required to access system-level data like compliance alerts.
 *
 * Data Structure:
 * - /users/{userId}/...: All user-specific data is nested under this path,
 *   creating a clear ownership boundary. This includes subcollections for
 *   `transactions` and `withdrawalRequests`.
 * - /complianceAlerts/{alertId}: A top-level collection for administrative data,
 *   structurally segregated from user data to enforce a different and more
 *   restrictive security policy.
 * - /roles_admin/{userId}: A lookup collection that defines who is an admin.
 *   The existence of a document here grants admin privileges.
 *
 * Key Security Decisions:
 * - User Data Privacy: A user can only ever access documents where the path
 *   contains their own UID. They cannot read or list any other user's data.
 * - Admin Segregation: Admins do not have blanket access to user data. Their
 *   privileges are scoped to specific administrative collections like
 *   /complianceAlerts.
 * - Client-Side Writes to Roles Denied: The /roles_admin collection is read-only
 *   for admins and completely inaccessible to regular users. This prevents any
 *   client-side attempts to escalate privileges. Role management must be done
 *   through a trusted server environment or the Firebase Console.
 * - Relational Integrity: On document creation, rules validate that internal ID
 *   fields (e.g., `userAccountId`) match the user's UID in the path, ensuring
 *   data is correctly associated with its owner from the start. These fields are
 *   enforced as immutable on update.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    /**
     * Returns true if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the authenticated user's UID matches the provided userId.
     * This is the foundation for the user-ownership security model.
     * @param userId The user ID to check against the authenticated user's UID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Returns true if the user is the owner AND the document already exists.
     * Used for safe update and delete operations.
     * @param userId The user ID to check for ownership.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Returns true if the user has an admin role.
     * Admin status is determined by the existence of a document for the user
     * in the /roles_admin collection.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    // -------------------------------------------------------------------------
    // User Data Collections
    // -------------------------------------------------------------------------

    /**
     * @description Controls access to a user's primary account document.
     * @path /users/{userId}
     * @allow (create) An authenticated user (UID 'user123') creating their own account document at `/users/user123`.
     * @deny (get) User 'user123' attempting to read the account document at `/users/user456`.
     * @deny (list) Any user attempting to list all documents in the `/users` collection.
     * @principle Enforces self-creation and strict data ownership for a user's root document.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);

      /**
       * @description Controls access to a user's transaction history.
       * @path /users/{userId}/transactions/{transactionId}
       * @allow (create) User 'user123' creating a new transaction in their own subcollection.
       * @allow (list) User 'user123' listing all documents at `/users/user123/transactions`.
       * @deny (get) User 'user456' attempting to read a transaction from `/users/user123/transactions/tx_abc`.
       * @principle Restricts access to a user's own private data tree.
       */
      match /transactions/{transactionId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.userAccountId == userId;
        allow update: if isExistingOwner(userId) && request.resource.data.userAccountId == resource.data.userAccountId;
        allow delete: if isExistingOwner(userId);
      }

      /**
       * @description Controls access to a user's withdrawal requests.
       * @path /users/{userId}/withdrawalRequests/{withdrawalRequestId}
       * @allow (create) User 'user123' creating a new withdrawal request in their own subcollection.
       * @allow (list) User 'user123' listing all documents at `/users/user123/withdrawalRequests`.
       * @deny (get) User 'user456' attempting to read a request from `/users/user123/withdrawalRequests/req_abc`.
       * @principle Restricts access to a user's own private data tree.
       */
      match /withdrawalRequests/{withdrawalRequestId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.userAccountId == userId;
        allow update: if isExistingOwner(userId) && request.resource.data.userAccountId == resource.data.userAccountId;
        allow delete: if isExistingOwner(userId);
      }
    }

    // -------------------------------------------------------------------------
    // Administrative Collections
    // -------------------------------------------------------------------------

    /**
     * @description Controls access to compliance alerts, which are only visible to admins.
     * @path /complianceAlerts/{complianceAlertId}
     * @allow (get) An authenticated admin user reading any compliance alert.
     * @deny (list) Any non-admin user attempting to list compliance alerts.
     * @deny (create) A non-admin user attempting to create a new compliance alert.
     * @principle Enforces strict Role-Based Access Control (RBAC) for sensitive system data.
     */
    match /complianceAlerts/{complianceAlertId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Secures the admin role definition collection itself. Admins can read
     *              this collection, but no user can modify it from the client.
     * @path /roles_admin/{userId}
     * @allow (get) An admin reading `/roles_admin/user123` to see if that user is an admin.
     * @deny (create) Any user (including an admin) trying to create a document to grant admin rights.
     * @deny (delete) Any user trying to delete a document to revoke admin rights.
     * @principle Secures the role management system by preventing client-side privilege escalation.
     */
    match /roles_admin/{userId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}